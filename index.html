<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>WaterHero v4.0 — 每日喝水紀錄（佈局最終穩定版）</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lottie-web@5.10.1/build/player/lottie.min.js"></script>

<style>
    /* 全局 CSS 重置 */
    * {
        box-sizing: border-box;
    }
    /* 核心佈局鎖定：確保 BODY 無邊界、無溢出，並強制置中 */
    body {
        margin: 0;
        padding: 0;
        overflow-x: hidden !important; 
        display: flex;
        justify-content: center; /* 讓主容器強制置中 */
        min-height: 100vh;
        width: 100%;
        color: #111827; /* 確保淺色背景下的主體文字是深色 */
    }
    
  .glass { backdrop-filter: blur(6px); background: rgba(255,255,255,0.65); }
  .dark .glass { background: rgba(17,24,39,0.55); }
  .badge-anim { width: 92px; height: 92px; }
  .progress-wave { background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0)); }

  /* 遊戲化區塊 */
  .water-bucket-wrapper { position: relative; width: 80px; height: 150px; border-radius: 5px 5px 20px 20px; overflow: hidden; }
  .bucket-outline { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 5px solid #a0a0a0; border-top: 10px solid #888; border-radius: 5px 5px 20px 20px; box-sizing: border-box; pointer-events: none; }
  .water-level { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: linear-gradient(to top, #007bff, #4dc3ff); transition: height 0.8s ease-out; border-radius: 0 0 15px 15px; }
  .flower-garden { display:flex; flex-wrap:wrap; justify-content:center; align-content:flex-start; width:100%; height:150px; overflow-y:auto; padding:5px; border-radius:10px; margin-bottom:10px; border:1px dashed #c4d7e9; background:#f7fff7; }
  .dark .flower-garden { background:#1a202c; border-color:#4a5568; }
  .flower-unit { font-size:2em; margin:3px; cursor:default; line-height:1; }
  #gardenMessage { font-size:0.9em; color:#999; padding-top:50px; text-align:center; width:100%; }
  /* Toast */
  #toast { 
        position: fixed; 
        right: 20px; 
        bottom: 24px; 
        z-index: 9999; 
        display:flex; 
        flex-direction:column; 
        gap:8px; 
        max-width: 90%; 
        top: auto; 
        left: auto;
    }
  .toast-item { 
        background: rgba(0,0,0,0.8); 
        color: #fff; 
        padding:10px 14px; 
        border-radius:8px; 
        min-width:160px; 
        box-shadow: 0 6px 18px rgba(0,0,0,0.2); 
        font-size:14px; 
    }
    /* 確保按鈕在手機上可以正確堆疊 */
    .btn-row {
        display: flex;
        gap: 0.5rem; /* gap-2 */
        width: 100%;
        margin-top: 0.5rem; /* mt-2 */
    }
    .btn-row button {
        flex: 1 1 50%; /* 讓按鈕平均分配空間 */
        min-width: 0;
    }
</style>
</head>
<body class="bg-gradient-to-b from-sky-50 to-white text-slate-800 min-h-screen">

<div id="toast"></div>

<div class="max-w-3xl mx-auto p-4"> 
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-slate-800">WaterHero v3.4 💧</h1>
    </div>
    <div class="flex items-center gap-3">
      <button id="notifyBtn" class="px-3 py-2 rounded-lg glass">提醒</button>
    </div>
  </header>

  <main class="grid gap-4 md:grid-cols-2">
    <form id="addForm" onsubmit="event.preventDefault();" novalidate class="md:col-span-2"> 
    <section class="p-4 rounded-2xl glass shadow">
        <div class="flex justify-between items-center mb-3">
          <div>
            <div class="text-sm text-slate-600">今日目標</div>
            <div class="text-xl font-bold"><span id="goalDisplay">2000</span> <span id="unitLabel">ml</span></div>
          </div>
          <div class="text-right">
            <div class="text-sm text-slate-600">已喝</div>
            <div class="text-xl font-bold"><span id="todayTotal">0</span> <span id="unitLabel2">ml</span></div>
          </div>
        </div>

      <div class="w-full text-center text-sm mb-3">
          <p class="font-medium text-slate-600">下次提醒倒數:</p>
          <div id="timerDisplay" class="text-lg font-bold text-sky-500">
              --:--:--
          </div>
      </div>
      
        <div class="w-full h-4 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden mb-3">
          <div id="progressBar" class="h-full bg-sky-400 dark:bg-sky-500 text-right progress-wave" style="width:0%"></div>
        </div>

        <div class="flex flex-col gap-3"> 
          <div class="flex items-center gap-3">
            <input id="addInput" type="number" placeholder="輸入喝水量 (例如 250)" class="flex-1 p-3 rounded-lg border border-slate-200 text-slate-800 bg-white">
            <select id="unitSelect" class="p-3 rounded-lg border border-slate-200 bg-white text-slate-800">
              <option value="ml">ml</option>
              <option value="cup">杯 (250ml)</option>
            </select>
          </div>

          <div class="btn-row"> 
            <button id="addBtn" class="bg-sky-600 text-white py-3 rounded-lg active:scale-95">加入</button> 
            <button id="undoBtn" class="bg-red-500 text-white py-3 rounded-lg active:scale-95" title="撤銷上一筆記錄">撤銷 ↶</button>
          </div>
        </div>
    </section>
    </form>

        <section class="p-4 rounded-2xl glass shadow">
      <h3 class="font-semibold text-lg mb-3 text-center">💧 澆花挑戰：累積與成長</h3>
      <div class="flex justify-around items-end h-48">
        <div class="water-bucket-wrapper">
          <div id="waterLevel" class="water-level"></div>
          <div class="bucket-outline"></div>
        </div>

        <div class="w-2/3 flex flex-col items-center justify-end h-full">
          <div id="flowerGarden" class="flower-garden"></div>
          <button id="waterFlowerBtn" disabled class="w-full px-4 py-2 rounded-lg bg-green-600 text-white disabled:bg-slate-400 disabled:cursor-not-allowed mt-2" title="累積 1000ml 水可澆花">
            💧 澆花 (1000ml)
          </button>
        </div>
      </div>
    </section>

        <section class="p-4 rounded-2xl glass shadow grid gap-3">
      <h3 class="font-semibold text-lg text-center">🏆 徽章與等級</h3>
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-300">水瓶名稱</div>
          <input id="bottleName" class="p-2 mt-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="為你的水瓶命名">
        </div>
        <div class="text-right">
          <div class="text-sm text-slate-500 dark:text-slate-300">等級</div>
          <div class="text-lg font-bold" id="bottleLevel">Lv.1</div>
        </div>
      </div>

      <div class="flex items-center gap-6">
        <div id="badgeContainer" class="badge-anim"></div>
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-300">連續達標 (streak)</div>
          <div class="text-2xl font-bold" id="streakCount">0</div>
          <div class="text-sm text-slate-500 dark:text-slate-300 mt-1" id="streakHint">連續達成每日目標可提升等級並解鎖徽章</div>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="claimBadge" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">領取徽章（達成時可點）</button>
        <button id="resetAll" class="px-4 py-2 rounded-lg bg-red-600 text-white">重設所有資料</button>
      </div>
    </section>

        <section class="p-4 rounded-2xl glass shadow md:col-span-2">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold">過去 7 天紀錄</h3>
        <div class="text-sm text-slate-500 dark:text-slate-300">查看趨勢以作為行為調整依據</div>
      </div>
      <canvas id="weekChart" height="140"></canvas>
      <div id="historyList" class="mt-3 text-sm text-slate-700 dark:text-slate-300"></div>
    </section>

        <section class="p-4 rounded-2xl glass shadow md:col-span-2">
      <h3 class="font-semibold text-lg">系統設定與操作</h3>
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-300">每日目標 (ml)</div>
          <input id="goalInput" type="number" min="100" class="p-2 mt-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800" value="2000">
        </div>
        <div class="text-right">
          <div class="text-sm text-slate-500 dark:text-slate-300">提醒間隔</div>
          <div class="flex gap-2 mt-1">
            <input id="reminderMinutes" type="number" min="10" value="120" class="p-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 w-24">
            <div class="self-center text-sm">分鐘</div>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="saveSettings" class="px-4 py-2 rounded-lg bg-green-600 text-white">儲存設定</button>
        <button id="resetToday" class="px-4 py-2 rounded-lg bg-amber-500 text-white">重設今日</button>
        <button id="exportBtn" class="px-4 py-2 rounded-lg bg-slate-600 text-white">匯出資料</button>
      </div>
      <div class="text-sm text-slate-500 dark:text-slate-300">說明：提醒需允許瀏覽器通知；資料存於本機，不會上傳。</div>
    </section>

    <footer class="text-xs text-slate-500 dark:text-slate-400 mt-4 md:col-span-2">
      說明：本系統以「最低阻力紀錄」為原則；提醒在分頁開啟狀態下有效；若需離線背景推播，建議升級為 PWA 或串接伺服器 Push。
    </footer>
  </main>
</div>

<script>
/*
  WaterHero v2.4 - 最終穩定版
  修正重點：移除所有 showToast 呼叫，確保靜默運行。
*/

const LS_KEY = 'waterhero_v1';
const MILLI_PER_DAY = 24*3600*1000;
const WATER_NEEDED_FOR_FLOWER = 1000;
const FINAL_FLOWER_ICON = "🌸";

/* ---------- Helpers ---------- */
function isoDate(d = new Date()){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().split('T')[0]; }
function showToast(msg, timeout = 3000){ console.log("TOAST:", msg); } // 訊息導向 Console

/* ---------- state + persistence ---------- */
function defaultState(){
  return {
    settings: { goal: 2000, unit: 'ml', reminderMinutes: 120, theme: 'light' },
    meta: {
      dailyIntakes: {},
      bucketAmount: 0,
      flowerGarden: [],
      streak: 0,
      lastAchieved: null,
      level: 1,
      badges: [],
      bottleName: '',
      lastIntake: null, // { date, amount, timestamp } 用於撤銷
      lastReminderTime: Date.now() // 新增：上次提醒時間
    }
  };
}

function loadState(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return defaultState();
    const parsed = JSON.parse(raw);
    if (!parsed.meta.lastReminderTime) parsed.meta.lastReminderTime = Date.now(); 
    return {...defaultState(), ...parsed};
  } catch(e){
    console.warn('localStorage load fail:', e);
    return defaultState();
  }
}

function saveState(){
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  } catch(e){
    console.warn('localStorage save fail：', e);
  }
}

/* ---------- app state (全域存取) ---------- */
let state = loadState();
let weekChart = null;
let reminderTimer = null;
let countdownTimer = null; // 倒數計時器
let lottiePlayer = null;

/* ---------- DOM refs (全域存取) ---------- */
const todayKey = () => isoDate();
const goalDisplay = document.getElementById('goalDisplay');
const todayTotalEl = document.getElementById('todayTotal');
const progressBar = document.getElementById('progressBar');
const addInput = document.getElementById('addInput');
const addBtn = document.getElementById('addBtn');
const undoBtn = document.getElementById('undoBtn');
const unitSelect = document.getElementById('unitSelect');
const unitLabel = document.getElementById('unitLabel');
const unitLabel2 = document.getElementById('unitLabel2');
const goalInput = document.getElementById('goalInput');
const saveSettings = document.getElementById('saveSettings');
const resetTodayBtn = document.getElementById('resetToday');
const weekChartCtx = document.getElementById('weekChart');
const historyList = document.getElementById('historyList');
const exportBtn = document.getElementById('exportBtn');
const bottleNameInput = document.getElementById('bottleName');
const bottleLevelEl = document.getElementById('bottleLevel');
const streakCountEl = document.getElementById('streakCount');
const badgeContainer = document.getElementById('badgeContainer');
const claimBadgeBtn = document.getElementById('claimBadge');
const resetAllBtn = document.getElementById('resetAll');
const waterLevelDisplay = document.getElementById('waterLevel');
const waterFlowerBtn = document.getElementById('waterFlowerBtn');
const flowerGardenDisplay = document.getElementById('flowerGarden');
const reminderMinutesInput = document.getElementById('reminderMinutes');
const notifyBtn = document.getElementById('notifyBtn');

// 新增倒數計時顯示元素
const timerDisplayEl = document.getElementById('timerDisplay');


/* ---------- core data helpers ---------- */
function getDailyIntakes(dateKey){ return state.meta.dailyIntakes[dateKey] || []; }
function getTotalFor(dateKey){ return getDailyIntakes(dateKey).reduce((s,v)=>s+v, 0); }
function pushIntake(dateKey, amount){
  if (!state.meta.dailyIntakes[dateKey]) state.meta.dailyIntakes[dateKey] = [];
  state.meta.dailyIntakes[dateKey].push(amount);
  state.meta.bucketAmount = (state.meta.bucketAmount || 0) + amount;
  state.meta.lastIntake = { date: dateKey, amount, timestamp: Date.now() };
  saveState();
}
function popLastIntake(dateKey){
  const arr = getDailyIntakes(dateKey);
  if (!arr || arr.length === 0) return null;
  const val = arr.pop();
  state.meta.bucketAmount = Math.max(0, (state.meta.bucketAmount || 0) - val);
  state.meta.lastIntake = null;
  saveState();
  return val;
}

/* ---------- actions ---------- */
function onAdd(){
  if(!addInput) return; // 確保元素存在
  
  const raw = parseFloat(addInput.value);
  // 這裡進行純 JS 驗證
  if (!raw || raw <= 0) { showToast('請輸入大於 0 的數字'); return; }
  let addMl = raw;
  if (unitSelect && unitSelect.value === 'cup') addMl = raw * 250;

  const key = todayKey();
  pushIntake(key, addMl);
  addInput.value = '';
  render();

  const prevTotal = getTotalFor(key) - addMl;
  const newTotal = getTotalFor(key);
  if (prevTotal < state.settings.goal && newTotal >= state.settings.goal){
    onAchieveToday();
  } else {
    console.log(`已新增 ${addMl} ml`); // 訊息導向 Console
  }
  state.meta.lastReminderTime = Date.now();
}

function onUndo(){
  const last = state.meta.lastIntake;
  if (!last) { console.log('錯誤: 無可撤銷的紀錄'); return; }
  
  const todayIntakes = getDailyIntakes(todayKey());
  if (todayIntakes.length === 0 || todayIntakes[todayIntakes.length - 1] !== last.amount || last.date !== todayKey()){
    console.log('錯誤: 只能撤銷上一次單筆喝水記錄');
    return;
  }
  
  const popped = popLastIntake(last.date);
  if (popped !== null){
    render();
    console.log(`已撤銷 ${popped} ml`);
  }
  state.meta.lastReminderTime = Date.now();
}

function onWaterFlower(){
  if (!waterFlowerBtn) return;
  if ((state.meta.bucketAmount || 0) < WATER_NEEDED_FOR_FLOWER){
    console.log(`水桶不足 ${WATER_NEEDED_FOR_FLOWER} ml 才能澆花`);
    return;
  }
  state.meta.bucketAmount -= WATER_NEEDED_FOR_FLOWER;
  state.meta.flowerGarden.push({ date: todayKey(), timestamp: Date.now() });
  saveState();
  render();
  console.log('澆花成功，花園新增一朵花 🌸');
}

/* ---------- achievement / level ---------- */
function onAchieveToday(){
  const yesterday = isoDate(new Date(Date.now() - MILLI_PER_DAY));
  const yesterdayReached = getTotalFor(yesterday) >= state.settings.goal;

  if (yesterdayReached && state.meta.lastAchieved === yesterday){ state.meta.streak = (state.meta.streak || 0) + 1; } 
  else { state.meta.streak = yesterdayReached ? (state.meta.streak || 0) + 1 : 1; }
  state.meta.lastAchieved = todayKey();
  updateBottleLevel();
  saveState();
  showNotification('今日目標達成 🎉', `已達成今日目標 ${state.settings.goal} ml`);
  playBadgeUnlock();
  console.log('今日達標！徽章已解鎖（可領取）');
}

function updateBottleLevel(){
  const s = state.meta.streak || 0;
  let lvl = 1;
  if (s >= 30) lvl = 5;
  else if (s >= 14) lvl = 4;
  else if (s >= 7) lvl = 3;
  else if (s >= 3) lvl = 2;
  state.meta.level = lvl;
  const badge = `Lv${lvl}-streak-${s}`;
  if (!state.meta.badges.includes(badge)) state.meta.badges.push(badge);
  saveState();
}

function onClaimBadge(){
  if (getTotalFor(todayKey()) < state.settings.goal) { console.log('尚未達成今日目標，無法領取徽章'); return; }
  const badge = `achieve-${todayKey()}`;
  if (!state.meta.badges.includes(badge)){
    saveState();
    console.log('徽章已領取並加入徽章牆');
  } else { console.log('本日徽章已領取'); }
  render();
}

/* ---------- settings / export / reset ---------- */
function onSaveSettings(){
  if(!goalInput || !reminderMinutesInput || !unitSelect) return console.log('錯誤：找不到設定元素');
  const g = parseInt(goalInput.value) || 2000;
  const rm = parseInt(reminderMinutesInput.value) || 120;
  state.settings.goal = Math.max(100, g);
  state.settings.reminderMinutes = Math.max(10, rm);
  state.settings.unit = unitSelect.value;
  saveState();
  startReminderTimerIfNeeded(true);
  console.log('設定已儲存');
  render();
}

function onResetToday(){
  if (!confirm('確認要重設今日喝水紀錄？此動作不可還原。')) return; // *保留 confirm*
  state.meta.dailyIntakes[todayKey()] = [];
  state.meta.lastIntake = null;
  saveState();
  render();
  console.log('今日紀錄已重設');
}

function onResetAll(){
  if (!confirm('重設所有資料（含 streak、徽章、歷史、花園）？')) return; // *保留 confirm*
  const token = prompt('輸入 "yes" 以確認重設'); // *保留 prompt*
  if (token !== 'yes') return;
  state = defaultState();
  saveState();
  location.reload();
}

function onExport(){
  if(!exportBtn) return;
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `waterhero_export_${isoDate()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  console.log('資料已匯出');
}

function onBottleNameChange(){
  if(!bottleNameInput) return;
  state.meta.bottleName = bottleNameInput.value.trim();
  saveState();
  console.log('水瓶名稱已儲存');
}

function onUnitChange(){
  if (unitSelect.value === 'cup') { unitLabel.textContent = '杯'; unitLabel2.textContent = '杯'; }
  else { unitLabel.textContent = 'ml'; unitLabel2.textContent = 'ml'; }
  state.settings.unit = unitSelect.value;
  saveState();
  render();
}

/* ---------- notifications / theme ---------- */
function applyTheme(t){
  if (t === 'dark') document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
  state.settings.theme = t;
  saveState();
}

function onToggleTheme(){
  const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
  applyTheme(next);
  console.log(`主題更新為 ${next}`);
}

// 倒數計時功能 (新功能)
function updateCountdown() {
    if(!timerDisplayEl) return;
    const nextTime = (state.meta.lastReminderTime || Date.now()) + (state.settings.reminderMinutes * 60 * 1000);
    const remainingMs = nextTime - Date.now();

    if (remainingMs <= 0) {
        timerDisplayEl.textContent = '已超時';
        return;
    }

    const totalSeconds = Math.floor(remainingMs / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    const pad = (num) => String(num).padStart(2, '0');

    if (hours > 0) {
        timerDisplayEl.textContent = `${pad(hours)}h ${pad(minutes)}m ${pad(seconds)}s`;
    } else {
        timerDisplayEl.textContent = `${pad(minutes)}:${pad(seconds)}`;
    }
}


function startCountdown() {
    if (countdownTimer) clearInterval(countdownTimer);
    updateCountdown(); // 立即更新一次
    countdownTimer = setInterval(updateCountdown, 1000);
}


async function onRequestNotify(){
  if (!confirm('確認要啟用提醒嗎？提醒將在本分頁開啟時，每隔 ' + state.settings.reminderMinutes + ' 分鐘跳出通知。')) {
        return;
    }
  if (!('Notification' in window)) { console.log('此瀏覽器不支援通知'); return; }
  try {
    const perm = await Notification.requestPermission();
    if (perm === 'granted') { 
        console.log('已取得通知權限（分頁開啟時生效）'); 
        showNotification('提醒已啟用', 'WaterHero 提醒已啟用'); 
        state.meta.lastReminderTime = Date.now(); // 啟用時重設時間
        startCountdown(); // 啟動倒數
    }
    else console.log('未取得通知權限');
  } catch(e){ console.warn(e); console.log('通知啟用失敗'); }
}

function showNotification(title, body){
  if (!('Notification' in window)) return;
  if (Notification.permission !== 'granted') return;
  try {
    const n = new Notification(title, { body: body, icon: null });
    n.onclick = () => window.focus();
  } catch(e) { console.warn('notification error', e); }
}

/* ---------- chart update trigger ---------- */
function initChart(){
  const cfg = {
    type: 'bar',
    data: { labels: [], datasets: [{ label: '每日總量 (ml)', data: [], borderRadius: 8, barThickness: 18 }]},
    options: {
      responsive: true,
      scales: { x: { grid: { display: false } }, y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  };
  if(weekChartCtx) weekChart = new Chart(weekChartCtx, cfg);
}

function updateChart(){
  if (!weekChart) return;
  const labels = [], dataPoints = [];
  for (let i=6;i>=0;i--){
    const key = isoDate(new Date(Date.now() - i*MILLI_PER_DAY));
    labels.push(key.slice(5));
    dataPoints.push(getTotalFor(key));
  }
  weekChart.data.labels = labels;
  weekChart.data.datasets[0].data = dataPoints;
  weekChart.update();
  renderHistoryList();
}

function renderHistoryList(){
  let html = '';
  const allKeys = Object.keys(state.meta.dailyIntakes).sort().slice(-14).reverse();
  if (allKeys.length === 0) html = '<div class="text-sm text-slate-500">尚無紀錄</div>';
  else {
    allKeys.forEach(k => {
      const v = getTotalFor(k);
      const intakes = getDailyIntakes(k).join(' + ');
      html += `<div class="flex flex-col py-1 border-b border-slate-100 dark:border-slate-700">
        <div class="flex justify-between font-semibold"><span>${k}</span><span>${v} ml</span></div>
        <div class="text-xs text-slate-500 dark:text-slate-400">詳情: ${intakes} ml</div>
      </div>`;
    });
  }
  if(historyList) historyList.innerHTML = html;
}

function render(){
  // 確保今日單筆記錄存在
  if (!state.meta.dailyIntakes[todayKey()]) state.meta.dailyIntakes[todayKey()] = [];

  // 核心 UI 更新
  if(goalDisplay) goalDisplay.textContent = state.settings.goal;
  const todayTotal = getTotalFor(todayKey());
  if(todayTotalEl) todayTotalEl.textContent = Math.round(todayTotal);
  const pct = Math.min(100, Math.round((todayTotal / state.settings.goal) * 100));
  if(progressBar) progressBar.style.width = pct + '%';

  // 遊戲化/徽章 UI 更新
  if(bottleLevelEl) bottleLevelEl.textContent = `Lv.${(state.meta.level || 1)}`;
  if(streakCountEl) streakCountEl.textContent = state.meta.streak || 0;
  if(bottleNameInput) bottleNameInput.value = state.meta.bottleName || '';

  // 水桶 UI
  const maxCapacity = WATER_NEEDED_FOR_FLOWER * 2;
  let levelPercentage = Math.min(((state.meta.bucketAmount || 0) / maxCapacity) * 100, 100);
  if(waterLevelDisplay) waterLevelDisplay.style.height = `${levelPercentage}%`;

  if (waterFlowerBtn) {
    if ((state.meta.bucketAmount || 0) >= WATER_NEEDED_FOR_FLOWER){
      waterFlowerBtn.disabled = false;
      waterFlowerBtn.title = `點擊澆花 (${WATER_NEEDED_FOR_FLOWER} ml)`;
    } else {
      waterFlowerBtn.disabled = true;
      const missing = WATER_NEEDED_FOR_FLOWER - (state.meta.bucketAmount || 0);
      waterFlowerBtn.title = `還需要 ${missing} ml 才能澆花`;
    }
  }

  renderGarden();
  updateChart();
  saveState();
}

function renderGarden(){
  const garden = state.meta.flowerGarden || [];
  if (!garden.length){
    if(flowerGardenDisplay) flowerGardenDisplay.innerHTML = `<p id="gardenMessage">你的花園還空空的，快來澆水吧！</p>`;
    return;
  }
  let html = '';
  garden.forEach(()=> html += `<span class="flower-unit">${FINAL_FLOWER_ICON}</span>`);
  if(flowerGardenDisplay) flowerGardenDisplay.innerHTML = html;
}

/* ---------- init ---------- */
window.onload = () => {
  // 綁定核心事件
  if (addBtn) addBtn.addEventListener('click', onAdd);
  if (addInput) addInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') onAdd(); });
  if (undoBtn) undoBtn.addEventListener('click', onUndo);
  if (waterFlowerBtn) waterFlowerBtn.addEventListener('click', onWaterFlower);
  
  // 綁定設置與輔助事件
  if (saveSettings) saveSettings.addEventListener('click', onSaveSettings);
  if (resetTodayBtn) resetTodayBtn.addEventListener('click', onResetToday);
  if (unitSelect) unitSelect.addEventListener('change', onUnitChange);
  if (exportBtn) exportBtn.addEventListener('click', onExport);
  if (bottleNameInput) bottleNameInput.addEventListener('change', onBottleNameChange);
  if (claimBadgeBtn) claimBadgeBtn.addEventListener('click', onClaimBadge);
  if (resetAllBtn) resetAllBtn.addEventListener('click', onResetAll);
  
  // 提醒功能 (修復點：直接在此處檢查並綁定)
  if (notifyBtn) notifyBtn.addEventListener('click', onRequestNotify);

  // 啟動依賴外部庫的功能
  initChart();
  initBadgeAnimation();
  startCountdown(); // 啟動倒數計時
  
  // 首次渲染
  render();
};
</script>
</body>
</html>
