<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>WaterHero v4.0 â€” æ¯æ—¥å–æ°´ç´€éŒ„ï¼ˆä½ˆå±€æœ€çµ‚ç©©å®šç‰ˆï¼‰</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lottie-web@5.10.1/build/player/lottie.min.js"></script>

<style>
    /* å…¨å±€ CSS é‡ç½® */
    * {
        box-sizing: border-box;
    }
    /* æ ¸å¿ƒä½ˆå±€é–å®šï¼šç¢ºä¿ BODY ç„¡é‚Šç•Œã€ç„¡æº¢å‡ºï¼Œä¸¦å¼·åˆ¶ç½®ä¸­ */
    body {
        margin: 0;
        padding: 0;
        overflow-x: hidden !important; 
        display: flex;
        justify-content: center; /* è®“ä¸»å®¹å™¨å¼·åˆ¶ç½®ä¸­ */
        min-height: 100vh;
        width: 100%;
        color: #111827; /* ç¢ºä¿æ·ºè‰²èƒŒæ™¯ä¸‹çš„ä¸»é«”æ–‡å­—æ˜¯æ·±è‰² */
    }
    
Â  .glass { backdrop-filter: blur(6px); background: rgba(255,255,255,0.65); }
Â  .dark .glass { background: rgba(17,24,39,0.55); }
Â  .badge-anim { width: 92px; height: 92px; }
Â  .progress-wave { background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0)); }

Â  /* éŠæˆ²åŒ–å€å¡Š */
Â  .water-bucket-wrapper { position: relative; width: 80px; height: 150px; border-radius: 5px 5px 20px 20px; overflow: hidden; }
Â  .bucket-outline { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 5px solid #a0a0a0; border-top: 10px solid #888; border-radius: 5px 5px 20px 20px; box-sizing: border-box; pointer-events: none; }
Â  .water-level { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: linear-gradient(to top, #007bff, #4dc3ff); transition: height 0.8s ease-out; border-radius: 0 0 15px 15px; }
Â  .flower-garden { display:flex; flex-wrap:wrap; justify-content:center; align-content:flex-start; width:100%; height:150px; overflow-y:auto; padding:5px; border-radius:10px; margin-bottom:10px; border:1px dashed #c4d7e9; background:#f7fff7; }
Â  .dark .flower-garden { background:#1a202c; border-color:#4a5568; }
Â  .flower-unit { font-size:2em; margin:3px; cursor:default; line-height:1; }
Â  #gardenMessage { font-size:0.9em; color:#999; padding-top:50px; text-align:center; width:100%; }
Â  /* Toast */
Â  #toast { 
        position: fixed; 
        right: 20px; 
        bottom: 24px; 
        z-index: 9999; 
        display:flex; 
        flex-direction:column; 
        gap:8px; 
        max-width: 90%; 
        top: auto; 
        left: auto;
    }
Â  .toast-item { 
        background: rgba(0,0,0,0.8); 
        color: #fff; 
        padding:10px 14px; 
        border-radius:8px; 
        min-width:160px; 
        box-shadow: 0 6px 18px rgba(0,0,0,0.2); 
        font-size:14px; 
    }
    /* ç¢ºä¿æŒ‰éˆ•åœ¨æ‰‹æ©Ÿä¸Šå¯ä»¥æ­£ç¢ºå †ç–Š */
    .btn-row {
        display: flex;
        gap: 0.5rem; /* gap-2 */
        width: 100%;
        margin-top: 0.5rem; /* mt-2 */
    }
    .btn-row button {
        flex: 1 1 50%; /* è®“æŒ‰éˆ•å¹³å‡åˆ†é…ç©ºé–“ */
        min-width: 0;
    }
</style>
</head>
<body class="bg-gradient-to-b from-sky-50 to-white text-slate-800 min-h-screen">

<div id="toast"></div>

<div class="max-w-3xl mx-auto p-4"> 
Â  <header class="flex items-center justify-between mb-6">
Â  Â  <div>
Â  Â  Â  <h1 class="text-2xl font-semibold text-slate-800">WaterHero v3.4 ğŸ’§</h1>
Â  Â  </div>
Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  <button id="notifyBtn" class="px-3 py-2 rounded-lg glass">æé†’</button>
Â  Â  </div>
Â  </header>

Â  <main class="grid gap-4 md:grid-cols-2">
Â  Â  <form id="addForm" onsubmit="event.preventDefault();" novalidate class="md:col-span-2"> 
    <section class="p-4 rounded-2xl glass shadow">
        <div class="flex justify-between items-center mb-3">
          <div>
            <div class="text-sm text-slate-600">ä»Šæ—¥ç›®æ¨™</div>
            <div class="text-xl font-bold"><span id="goalDisplay">2000</span> <span id="unitLabel">ml</span></div>
          </div>
          <div class="text-right">
            <div class="text-sm text-slate-600">å·²å–</div>
            <div class="text-xl font-bold"><span id="todayTotal">0</span> <span id="unitLabel2">ml</span></div>
          </div>
        </div>

      <div class="w-full text-center text-sm mb-3">
          <p class="font-medium text-slate-600">ä¸‹æ¬¡æé†’å€’æ•¸:</p>
          <div id="timerDisplay" class="text-lg font-bold text-sky-500">
              --:--:--
          </div>
      </div>
      
        <div class="w-full h-4 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden mb-3">
          <div id="progressBar" class="h-full bg-sky-400 dark:bg-sky-500 text-right progress-wave" style="width:0%"></div>
        </div>

        <div class="flex flex-col gap-3"> 
          <div class="flex items-center gap-3">
            <input id="addInput" type="number" placeholder="è¼¸å…¥å–æ°´é‡ (ä¾‹å¦‚ 250)" class="flex-1 p-3 rounded-lg border border-slate-200 text-slate-800 bg-white">
            <select id="unitSelect" class="p-3 rounded-lg border border-slate-200 bg-white text-slate-800">
              <option value="ml">ml</option>
              <option value="cup">æ¯ (250ml)</option>
            </select>
          </div>

          <div class="btn-row"> 
            <button id="addBtn" class="bg-sky-600 text-white py-3 rounded-lg active:scale-95">åŠ å…¥</button> 
            <button id="undoBtn" class="bg-red-500 text-white py-3 rounded-lg active:scale-95" title="æ’¤éŠ·ä¸Šä¸€ç­†è¨˜éŒ„">æ’¤éŠ· â†¶</button>
          </div>
        </div>
Â  Â  </section>
    </form>

Â  Â  Â  Â  <section class="p-4 rounded-2xl glass shadow">
Â  Â  Â  <h3 class="font-semibold text-lg mb-3 text-center">ğŸ’§ æ¾†èŠ±æŒ‘æˆ°ï¼šç´¯ç©èˆ‡æˆé•·</h3>
Â  Â  Â  <div class="flex justify-around items-end h-48">
Â  Â  Â  Â  <div class="water-bucket-wrapper">
Â  Â  Â  Â  Â  <div id="waterLevel" class="water-level"></div>
Â  Â  Â  Â  Â  <div class="bucket-outline"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="w-2/3 flex flex-col items-center justify-end h-full">
Â  Â  Â  Â  Â  <div id="flowerGarden" class="flower-garden"></div>
Â  Â  Â  Â  Â  <button id="waterFlowerBtn" disabled class="w-full px-4 py-2 rounded-lg bg-green-600 text-white disabled:bg-slate-400 disabled:cursor-not-allowed mt-2" title="ç´¯ç© 1000ml æ°´å¯æ¾†èŠ±">
Â  Â  Â  Â  Â  Â  ğŸ’§ æ¾†èŠ± (1000ml)
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section class="p-4 rounded-2xl glass shadow grid gap-3">
Â  Â  Â  <h3 class="font-semibold text-lg text-center">ğŸ† å¾½ç« èˆ‡ç­‰ç´š</h3>
Â  Â  Â  <div class="flex items-center justify-between">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="text-sm text-slate-500 dark:text-slate-300">æ°´ç“¶åç¨±</div>
Â  Â  Â  Â  Â  <input id="bottleName" class="p-2 mt-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="ç‚ºä½ çš„æ°´ç“¶å‘½å">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="text-right">
Â  Â  Â  Â  Â  <div class="text-sm text-slate-500 dark:text-slate-300">ç­‰ç´š</div>
Â  Â  Â  Â  Â  <div class="text-lg font-bold" id="bottleLevel">Lv.1</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="flex items-center gap-6">
Â  Â  Â  Â  <div id="badgeContainer" class="badge-anim"></div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="text-sm text-slate-500 dark:text-slate-300">é€£çºŒé”æ¨™ (streak)</div>
Â  Â  Â  Â  Â  <div class="text-2xl font-bold" id="streakCount">0</div>
Â  Â  Â  Â  Â  <div class="text-sm text-slate-500 dark:text-slate-300 mt-1" id="streakHint">é€£çºŒé”æˆæ¯æ—¥ç›®æ¨™å¯æå‡ç­‰ç´šä¸¦è§£é–å¾½ç« </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  <button id="claimBadge" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">é ˜å–å¾½ç« ï¼ˆé”æˆæ™‚å¯é»ï¼‰</button>
Â  Â  Â  Â  <button id="resetAll" class="px-4 py-2 rounded-lg bg-red-600 text-white">é‡è¨­æ‰€æœ‰è³‡æ–™</button>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section class="p-4 rounded-2xl glass shadow md:col-span-2">
Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  <h3 class="font-semibold">éå» 7 å¤©ç´€éŒ„</h3>
Â  Â  Â  Â  <div class="text-sm text-slate-500 dark:text-slate-300">æŸ¥çœ‹è¶¨å‹¢ä»¥ä½œç‚ºè¡Œç‚ºèª¿æ•´ä¾æ“š</div>
Â  Â  Â  </div>
Â  Â  Â  <canvas id="weekChart" height="140"></canvas>
Â  Â  Â  <div id="historyList" class="mt-3 text-sm text-slate-700 dark:text-slate-300"></div>
Â  Â  </section>

Â  Â  Â  Â  <section class="p-4 rounded-2xl glass shadow md:col-span-2">
Â  Â  Â  <h3 class="font-semibold text-lg">ç³»çµ±è¨­å®šèˆ‡æ“ä½œ</h3>
Â  Â  Â  <div class="flex items-center justify-between">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="text-sm text-slate-500 dark:text-slate-300">æ¯æ—¥ç›®æ¨™ (ml)</div>
Â  Â  Â  Â  Â  <input id="goalInput" type="number" min="100" class="p-2 mt-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800" value="2000">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="text-right">
Â  Â  Â  Â  Â  <div class="text-sm text-slate-500 dark:text-slate-300">æé†’é–“éš”</div>
Â  Â  Â  Â  Â  <div class="flex gap-2 mt-1">
Â  Â  Â  Â  Â  Â  <input id="reminderMinutes" type="number" min="10" value="120" class="p-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 w-24">
Â  Â  Â  Â  Â  Â  <div class="self-center text-sm">åˆ†é˜</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  <button id="saveSettings" class="px-4 py-2 rounded-lg bg-green-600 text-white">å„²å­˜è¨­å®š</button>
Â  Â  Â  Â  <button id="resetToday" class="px-4 py-2 rounded-lg bg-amber-500 text-white">é‡è¨­ä»Šæ—¥</button>
Â  Â  Â  Â  <button id="exportBtn" class="px-4 py-2 rounded-lg bg-slate-600 text-white">åŒ¯å‡ºè³‡æ–™</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="text-sm text-slate-500 dark:text-slate-300">èªªæ˜ï¼šæé†’éœ€å…è¨±ç€è¦½å™¨é€šçŸ¥ï¼›è³‡æ–™å­˜æ–¼æœ¬æ©Ÿï¼Œä¸æœƒä¸Šå‚³ã€‚</div>
Â  Â  </section>

Â  Â  <footer class="text-xs text-slate-500 dark:text-slate-400 mt-4 md:col-span-2">
Â  Â  Â  èªªæ˜ï¼šæœ¬ç³»çµ±ä»¥ã€Œæœ€ä½é˜»åŠ›ç´€éŒ„ã€ç‚ºåŸå‰‡ï¼›æé†’åœ¨åˆ†é é–‹å•Ÿç‹€æ…‹ä¸‹æœ‰æ•ˆï¼›è‹¥éœ€é›¢ç·šèƒŒæ™¯æ¨æ’­ï¼Œå»ºè­°å‡ç´šç‚º PWA æˆ–ä¸²æ¥ä¼ºæœå™¨ Pushã€‚
Â  Â  </footer>
Â  </main>
</div>

<script>
/*
Â  WaterHero v2.4 - æœ€çµ‚ç©©å®šç‰ˆ
Â  ä¿®æ­£é‡é»ï¼šç§»é™¤æ‰€æœ‰ showToast å‘¼å«ï¼Œç¢ºä¿éœé»˜é‹è¡Œã€‚
*/

const LS_KEY = 'waterhero_v1';
const MILLI_PER_DAY = 24*3600*1000;
const WATER_NEEDED_FOR_FLOWER = 1000;
const FINAL_FLOWER_ICON = "ğŸŒ¸";

/* ---------- Helpers ---------- */
function isoDate(d = new Date()){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().split('T')[0]; }
function showToast(msg, timeout = 3000){ console.log("TOAST:", msg); } // è¨Šæ¯å°å‘ Console

/* ---------- state + persistence ---------- */
function defaultState(){
Â  return {
Â  Â  settings: { goal: 2000, unit: 'ml', reminderMinutes: 120, theme: 'light' },
Â  Â  meta: {
Â  Â  Â  dailyIntakes: {},
Â  Â  Â  bucketAmount: 0,
Â  Â  Â  flowerGarden: [],
Â  Â  Â  streak: 0,
Â  Â  Â  lastAchieved: null,
Â  Â  Â  level: 1,
Â  Â  Â  badges: [],
Â  Â  Â  bottleName: '',
Â  Â  Â  lastIntake: null, // { date, amount, timestamp } ç”¨æ–¼æ’¤éŠ·
Â  Â  Â  lastReminderTime: Date.now() // æ–°å¢ï¼šä¸Šæ¬¡æé†’æ™‚é–“
Â  Â  }
Â  };
}

function loadState(){
Â  try {
Â  Â  const raw = localStorage.getItem(LS_KEY);
Â  Â  if (!raw) return defaultState();
Â  Â  const parsed = JSON.parse(raw);
Â  Â  if (!parsed.meta.lastReminderTime) parsed.meta.lastReminderTime = Date.now(); 
Â  Â  return {...defaultState(), ...parsed};
Â  } catch(e){
Â  Â  console.warn('localStorage load fail:', e);
Â  Â  return defaultState();
Â  }
}

function saveState(){
Â  try {
Â  Â  localStorage.setItem(LS_KEY, JSON.stringify(state));
Â  } catch(e){
Â  Â  console.warn('localStorage save failï¼š', e);
Â  }
}

/* ---------- app state (å…¨åŸŸå­˜å–) ---------- */
let state = loadState();
let weekChart = null;
let reminderTimer = null;
let countdownTimer = null; // å€’æ•¸è¨ˆæ™‚å™¨
let lottiePlayer = null;

/* ---------- DOM refs (å…¨åŸŸå­˜å–) ---------- */
const todayKey = () => isoDate();
const goalDisplay = document.getElementById('goalDisplay');
const todayTotalEl = document.getElementById('todayTotal');
const progressBar = document.getElementById('progressBar');
const addInput = document.getElementById('addInput');
const addBtn = document.getElementById('addBtn');
const undoBtn = document.getElementById('undoBtn');
const unitSelect = document.getElementById('unitSelect');
const unitLabel = document.getElementById('unitLabel');
const unitLabel2 = document.getElementById('unitLabel2');
const goalInput = document.getElementById('goalInput');
const saveSettings = document.getElementById('saveSettings');
const resetTodayBtn = document.getElementById('resetToday');
const weekChartCtx = document.getElementById('weekChart');
const historyList = document.getElementById('historyList');
const exportBtn = document.getElementById('exportBtn');
const bottleNameInput = document.getElementById('bottleName');
const bottleLevelEl = document.getElementById('bottleLevel');
const streakCountEl = document.getElementById('streakCount');
const badgeContainer = document.getElementById('badgeContainer');
const claimBadgeBtn = document.getElementById('claimBadge');
const resetAllBtn = document.getElementById('resetAll');
const waterLevelDisplay = document.getElementById('waterLevel');
const waterFlowerBtn = document.getElementById('waterFlowerBtn');
const flowerGardenDisplay = document.getElementById('flowerGarden');
const reminderMinutesInput = document.getElementById('reminderMinutes');
const notifyBtn = document.getElementById('notifyBtn');

// æ–°å¢å€’æ•¸è¨ˆæ™‚é¡¯ç¤ºå…ƒç´ 
const timerDisplayEl = document.getElementById('timerDisplay');


/* ---------- core data helpers ---------- */
function getDailyIntakes(dateKey){ return state.meta.dailyIntakes[dateKey] || []; }
function getTotalFor(dateKey){ return getDailyIntakes(dateKey).reduce((s,v)=>s+v, 0); }
function pushIntake(dateKey, amount){
Â  if (!state.meta.dailyIntakes[dateKey]) state.meta.dailyIntakes[dateKey] = [];
Â  state.meta.dailyIntakes[dateKey].push(amount);
Â  state.meta.bucketAmount = (state.meta.bucketAmount || 0) + amount;
Â  state.meta.lastIntake = { date: dateKey, amount, timestamp: Date.now() };
Â  saveState();
}
function popLastIntake(dateKey){
Â  const arr = getDailyIntakes(dateKey);
Â  if (!arr || arr.length === 0) return null;
Â  const val = arr.pop();
Â  state.meta.bucketAmount = Math.max(0, (state.meta.bucketAmount || 0) - val);
Â  state.meta.lastIntake = null;
Â  saveState();
Â  return val;
}

/* ---------- actions ---------- */
function onAdd(){
Â  if(!addInput) return; // ç¢ºä¿å…ƒç´ å­˜åœ¨
Â  
Â  const raw = parseFloat(addInput.value);
Â  // é€™è£¡é€²è¡Œç´” JS é©—è­‰
Â  if (!raw || raw <= 0) { showToast('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ•¸å­—'); return; }
Â  let addMl = raw;
Â  if (unitSelect && unitSelect.value === 'cup') addMl = raw * 250;

Â  const key = todayKey();
Â  pushIntake(key, addMl);
Â  addInput.value = '';
Â  render();

Â  const prevTotal = getTotalFor(key) - addMl;
Â  const newTotal = getTotalFor(key);
Â  if (prevTotal < state.settings.goal && newTotal >= state.settings.goal){
Â  Â  onAchieveToday();
Â  } else {
Â  Â  console.log(`å·²æ–°å¢ ${addMl} ml`); // è¨Šæ¯å°å‘ Console
Â  }
Â  state.meta.lastReminderTime = Date.now();
}

function onUndo(){
Â  const last = state.meta.lastIntake;
Â  if (!last) { console.log('éŒ¯èª¤: ç„¡å¯æ’¤éŠ·çš„ç´€éŒ„'); return; }
Â  
Â  const todayIntakes = getDailyIntakes(todayKey());
Â  if (todayIntakes.length === 0 || todayIntakes[todayIntakes.length - 1] !== last.amount || last.date !== todayKey()){
Â  Â  console.log('éŒ¯èª¤: åªèƒ½æ’¤éŠ·ä¸Šä¸€æ¬¡å–®ç­†å–æ°´è¨˜éŒ„');
Â  Â  return;
Â  }
Â  
Â  const popped = popLastIntake(last.date);
Â  if (popped !== null){
Â  Â  render();
Â  Â  console.log(`å·²æ’¤éŠ· ${popped} ml`);
Â  }
Â  state.meta.lastReminderTime = Date.now();
}

function onWaterFlower(){
Â  if (!waterFlowerBtn) return;
Â  if ((state.meta.bucketAmount || 0) < WATER_NEEDED_FOR_FLOWER){
Â  Â  console.log(`æ°´æ¡¶ä¸è¶³ ${WATER_NEEDED_FOR_FLOWER} ml æ‰èƒ½æ¾†èŠ±`);
Â  Â  return;
Â  }
Â  state.meta.bucketAmount -= WATER_NEEDED_FOR_FLOWER;
Â  state.meta.flowerGarden.push({ date: todayKey(), timestamp: Date.now() });
Â  saveState();
Â  render();
Â  console.log('æ¾†èŠ±æˆåŠŸï¼ŒèŠ±åœ’æ–°å¢ä¸€æœµèŠ± ğŸŒ¸');
}

/* ---------- achievement / level ---------- */
function onAchieveToday(){
Â  const yesterday = isoDate(new Date(Date.now() - MILLI_PER_DAY));
Â  const yesterdayReached = getTotalFor(yesterday) >= state.settings.goal;

Â  if (yesterdayReached && state.meta.lastAchieved === yesterday){ state.meta.streak = (state.meta.streak || 0) + 1; } 
Â  else { state.meta.streak = yesterdayReached ? (state.meta.streak || 0) + 1 : 1; }
Â  state.meta.lastAchieved = todayKey();
Â  updateBottleLevel();
Â  saveState();
Â  showNotification('ä»Šæ—¥ç›®æ¨™é”æˆ ğŸ‰', `å·²é”æˆä»Šæ—¥ç›®æ¨™ ${state.settings.goal} ml`);
Â  playBadgeUnlock();
Â  console.log('ä»Šæ—¥é”æ¨™ï¼å¾½ç« å·²è§£é–ï¼ˆå¯é ˜å–ï¼‰');
}

function updateBottleLevel(){
Â  const s = state.meta.streak || 0;
Â  let lvl = 1;
Â  if (s >= 30) lvl = 5;
Â  else if (s >= 14) lvl = 4;
Â  else if (s >= 7) lvl = 3;
Â  else if (s >= 3) lvl = 2;
Â  state.meta.level = lvl;
Â  const badge = `Lv${lvl}-streak-${s}`;
Â  if (!state.meta.badges.includes(badge)) state.meta.badges.push(badge);
Â  saveState();
}

function onClaimBadge(){
Â  if (getTotalFor(todayKey()) < state.settings.goal) { console.log('å°šæœªé”æˆä»Šæ—¥ç›®æ¨™ï¼Œç„¡æ³•é ˜å–å¾½ç« '); return; }
Â  const badge = `achieve-${todayKey()}`;
Â  if (!state.meta.badges.includes(badge)){
Â  Â  saveState();
Â  Â  console.log('å¾½ç« å·²é ˜å–ä¸¦åŠ å…¥å¾½ç« ç‰†');
Â  } else { console.log('æœ¬æ—¥å¾½ç« å·²é ˜å–'); }
Â  render();
}

/* ---------- settings / export / reset ---------- */
function onSaveSettings(){
Â  if(!goalInput || !reminderMinutesInput || !unitSelect) return console.log('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¨­å®šå…ƒç´ ');
Â  const g = parseInt(goalInput.value) || 2000;
Â  const rm = parseInt(reminderMinutesInput.value) || 120;
Â  state.settings.goal = Math.max(100, g);
Â  state.settings.reminderMinutes = Math.max(10, rm);
Â  state.settings.unit = unitSelect.value;
Â  saveState();
Â  startReminderTimerIfNeeded(true);
Â  console.log('è¨­å®šå·²å„²å­˜');
Â  render();
}

function onResetToday(){
Â  if (!confirm('ç¢ºèªè¦é‡è¨­ä»Šæ—¥å–æ°´ç´€éŒ„ï¼Ÿæ­¤å‹•ä½œä¸å¯é‚„åŸã€‚')) return; // *ä¿ç•™ confirm*
Â  state.meta.dailyIntakes[todayKey()] = [];
Â  state.meta.lastIntake = null;
Â  saveState();
Â  render();
Â  console.log('ä»Šæ—¥ç´€éŒ„å·²é‡è¨­');
}

function onResetAll(){
Â  if (!confirm('é‡è¨­æ‰€æœ‰è³‡æ–™ï¼ˆå« streakã€å¾½ç« ã€æ­·å²ã€èŠ±åœ’ï¼‰ï¼Ÿ')) return; // *ä¿ç•™ confirm*
Â  const token = prompt('è¼¸å…¥ "yes" ä»¥ç¢ºèªé‡è¨­'); // *ä¿ç•™ prompt*
Â  if (token !== 'yes') return;
Â  state = defaultState();
Â  saveState();
Â  location.reload();
}

function onExport(){
Â  if(!exportBtn) return;
Â  const dataStr = JSON.stringify(state, null, 2);
Â  const blob = new Blob([dataStr], { type: 'application/json' });
Â  const url = URL.createObjectURL(blob);
Â  const a = document.createElement('a');
Â  a.href = url;
Â  a.download = `waterhero_export_${isoDate()}.json`;
Â  a.click();
Â  URL.revokeObjectURL(url);
Â  console.log('è³‡æ–™å·²åŒ¯å‡º');
}

function onBottleNameChange(){
Â  if(!bottleNameInput) return;
Â  state.meta.bottleName = bottleNameInput.value.trim();
Â  saveState();
Â  console.log('æ°´ç“¶åç¨±å·²å„²å­˜');
}

function onUnitChange(){
Â  if (unitSelect.value === 'cup') { unitLabel.textContent = 'æ¯'; unitLabel2.textContent = 'æ¯'; }
Â  else { unitLabel.textContent = 'ml'; unitLabel2.textContent = 'ml'; }
Â  state.settings.unit = unitSelect.value;
Â  saveState();
Â  render();
}

/* ---------- notifications / theme ---------- */
function applyTheme(t){
Â  if (t === 'dark') document.documentElement.classList.add('dark');
Â  else document.documentElement.classList.remove('dark');
Â  state.settings.theme = t;
Â  saveState();
}

function onToggleTheme(){
Â  const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
Â  applyTheme(next);
Â  console.log(`ä¸»é¡Œæ›´æ–°ç‚º ${next}`);
}

// å€’æ•¸è¨ˆæ™‚åŠŸèƒ½ (æ–°åŠŸèƒ½)
function updateCountdown() {
    if(!timerDisplayEl) return;
    const nextTime = (state.meta.lastReminderTime || Date.now()) + (state.settings.reminderMinutes * 60 * 1000);
    const remainingMs = nextTime - Date.now();

    if (remainingMs <= 0) {
        timerDisplayEl.textContent = 'å·²è¶…æ™‚';
        return;
    }

    const totalSeconds = Math.floor(remainingMs / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    const pad = (num) => String(num).padStart(2, '0');

    if (hours > 0) {
        timerDisplayEl.textContent = `${pad(hours)}h ${pad(minutes)}m ${pad(seconds)}s`;
    } else {
        timerDisplayEl.textContent = `${pad(minutes)}:${pad(seconds)}`;
    }
}


function startCountdown() {
    if (countdownTimer) clearInterval(countdownTimer);
    updateCountdown(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
    countdownTimer = setInterval(updateCountdown, 1000);
}


async function onRequestNotify(){
Â  if (!confirm('ç¢ºèªè¦å•Ÿç”¨æé†’å—ï¼Ÿæé†’å°‡åœ¨æœ¬åˆ†é é–‹å•Ÿæ™‚ï¼Œæ¯éš” ' + state.settings.reminderMinutes + ' åˆ†é˜è·³å‡ºé€šçŸ¥ã€‚')) {
        return;
    }
Â  if (!('Notification' in window)) { console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥'); return; }
Â  try {
Â  Â  const perm = await Notification.requestPermission();
Â  Â  if (perm === 'granted') { 
        console.log('å·²å–å¾—é€šçŸ¥æ¬Šé™ï¼ˆåˆ†é é–‹å•Ÿæ™‚ç”Ÿæ•ˆï¼‰'); 
        showNotification('æé†’å·²å•Ÿç”¨', 'WaterHero æé†’å·²å•Ÿç”¨'); 
        state.meta.lastReminderTime = Date.now(); // å•Ÿç”¨æ™‚é‡è¨­æ™‚é–“
        startCountdown(); // å•Ÿå‹•å€’æ•¸
    }
Â  Â  else console.log('æœªå–å¾—é€šçŸ¥æ¬Šé™');
Â  } catch(e){ console.warn(e); console.log('é€šçŸ¥å•Ÿç”¨å¤±æ•—'); }
}

function showNotification(title, body){
Â  if (!('Notification' in window)) return;
Â  if (Notification.permission !== 'granted') return;
Â  try {
Â  Â  const n = new Notification(title, { body: body, icon: null });
Â  Â  n.onclick = () => window.focus();
Â  } catch(e) { console.warn('notification error', e); }
}

/* ---------- chart update trigger ---------- */
function initChart(){
Â  const cfg = {
Â  Â  type: 'bar',
Â  Â  data: { labels: [], datasets: [{ label: 'æ¯æ—¥ç¸½é‡ (ml)', data: [], borderRadius: 8, barThickness: 18 }]},
Â  Â  options: {
Â  Â  Â  responsive: true,
Â  Â  Â  scales: { x: { grid: { display: false } }, y: { beginAtZero: true } },
Â  Â  Â  plugins: { legend: { display: false } }
Â  Â  }
Â  };
Â  if(weekChartCtx) weekChart = new Chart(weekChartCtx, cfg);
}

function updateChart(){
Â  if (!weekChart) return;
Â  const labels = [], dataPoints = [];
Â  for (let i=6;i>=0;i--){
Â  Â  const key = isoDate(new Date(Date.now() - i*MILLI_PER_DAY));
Â  Â  labels.push(key.slice(5));
Â  Â  dataPoints.push(getTotalFor(key));
Â  }
Â  weekChart.data.labels = labels;
Â  weekChart.data.datasets[0].data = dataPoints;
Â  weekChart.update();
Â  renderHistoryList();
}

function renderHistoryList(){
Â  let html = '';
Â  const allKeys = Object.keys(state.meta.dailyIntakes).sort().slice(-14).reverse();
Â  if (allKeys.length === 0) html = '<div class="text-sm text-slate-500">å°šç„¡ç´€éŒ„</div>';
Â  else {
Â  Â  allKeys.forEach(k => {
Â  Â  Â  const v = getTotalFor(k);
Â  Â  Â  const intakes = getDailyIntakes(k).join(' + ');
Â  Â  Â  html += `<div class="flex flex-col py-1 border-b border-slate-100 dark:border-slate-700">
Â  Â  Â  Â  <div class="flex justify-between font-semibold"><span>${k}</span><span>${v} ml</span></div>
Â  Â  Â  Â  <div class="text-xs text-slate-500 dark:text-slate-400">è©³æƒ…: ${intakes} ml</div>
Â  Â  Â  </div>`;
Â  Â  });
Â  }
Â  if(historyList) historyList.innerHTML = html;
}

function render(){
Â  // ç¢ºä¿ä»Šæ—¥å–®ç­†è¨˜éŒ„å­˜åœ¨
Â  if (!state.meta.dailyIntakes[todayKey()]) state.meta.dailyIntakes[todayKey()] = [];

Â  // æ ¸å¿ƒ UI æ›´æ–°
Â  if(goalDisplay) goalDisplay.textContent = state.settings.goal;
Â  const todayTotal = getTotalFor(todayKey());
Â  if(todayTotalEl) todayTotalEl.textContent = Math.round(todayTotal);
Â  const pct = Math.min(100, Math.round((todayTotal / state.settings.goal) * 100));
Â  if(progressBar) progressBar.style.width = pct + '%';

Â  // éŠæˆ²åŒ–/å¾½ç«  UI æ›´æ–°
Â  if(bottleLevelEl) bottleLevelEl.textContent = `Lv.${(state.meta.level || 1)}`;
Â  if(streakCountEl) streakCountEl.textContent = state.meta.streak || 0;
Â  if(bottleNameInput) bottleNameInput.value = state.meta.bottleName || '';

Â  // æ°´æ¡¶ UI
Â  const maxCapacity = WATER_NEEDED_FOR_FLOWER * 2;
Â  let levelPercentage = Math.min(((state.meta.bucketAmount || 0) / maxCapacity) * 100, 100);
Â  if(waterLevelDisplay) waterLevelDisplay.style.height = `${levelPercentage}%`;

Â  if (waterFlowerBtn) {
Â  Â  if ((state.meta.bucketAmount || 0) >= WATER_NEEDED_FOR_FLOWER){
Â  Â  Â  waterFlowerBtn.disabled = false;
Â  Â  Â  waterFlowerBtn.title = `é»æ“Šæ¾†èŠ± (${WATER_NEEDED_FOR_FLOWER} ml)`;
Â  Â  } else {
Â  Â  Â  waterFlowerBtn.disabled = true;
Â  Â  Â  const missing = WATER_NEEDED_FOR_FLOWER - (state.meta.bucketAmount || 0);
Â  Â  Â  waterFlowerBtn.title = `é‚„éœ€è¦ ${missing} ml æ‰èƒ½æ¾†èŠ±`;
Â  Â  }
Â  }

Â  renderGarden();
Â  updateChart();
Â  saveState();
}

function renderGarden(){
Â  const garden = state.meta.flowerGarden || [];
Â  if (!garden.length){
Â  Â  if(flowerGardenDisplay) flowerGardenDisplay.innerHTML = `<p id="gardenMessage">ä½ çš„èŠ±åœ’é‚„ç©ºç©ºçš„ï¼Œå¿«ä¾†æ¾†æ°´å§ï¼</p>`;
Â  Â  return;
Â  }
Â  let html = '';
Â  garden.forEach(()=> html += `<span class="flower-unit">${FINAL_FLOWER_ICON}</span>`);
Â  if(flowerGardenDisplay) flowerGardenDisplay.innerHTML = html;
}

/* ---------- init ---------- */
window.onload = () => {
Â  // ç¶å®šæ ¸å¿ƒäº‹ä»¶
Â  if (addBtn) addBtn.addEventListener('click', onAdd);
Â  if (addInput) addInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') onAdd(); });
Â  if (undoBtn) undoBtn.addEventListener('click', onUndo);
Â  if (waterFlowerBtn) waterFlowerBtn.addEventListener('click', onWaterFlower);
Â  
Â  // ç¶å®šè¨­ç½®èˆ‡è¼”åŠ©äº‹ä»¶
Â  if (saveSettings) saveSettings.addEventListener('click', onSaveSettings);
Â  if (resetTodayBtn) resetTodayBtn.addEventListener('click', onResetToday);
Â  if (unitSelect) unitSelect.addEventListener('change', onUnitChange);
Â  if (exportBtn) exportBtn.addEventListener('click', onExport);
Â  if (bottleNameInput) bottleNameInput.addEventListener('change', onBottleNameChange);
Â  if (claimBadgeBtn) claimBadgeBtn.addEventListener('click', onClaimBadge);
Â  if (resetAllBtn) resetAllBtn.addEventListener('click', onResetAll);
Â  
Â  // æé†’åŠŸèƒ½ (ä¿®å¾©é»ï¼šç›´æ¥åœ¨æ­¤è™•æª¢æŸ¥ä¸¦ç¶å®š)
Â  if (notifyBtn) notifyBtn.addEventListener('click', onRequestNotify);

Â  // å•Ÿå‹•ä¾è³´å¤–éƒ¨åº«çš„åŠŸèƒ½
Â  initChart();
Â  initBadgeAnimation();
Â  startCountdown(); // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
Â  
Â  // é¦–æ¬¡æ¸²æŸ“
Â  render();
};
</script>
</body>
</html>
